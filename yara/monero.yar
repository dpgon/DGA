rule win_monero_miner_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2021-06-10"
        version = "1"
        description = "Detects win.monero_miner."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.monero_miner"
        malpedia_rule_date = "20210604"
        malpedia_hash = "be09d5d71e77373c0f538068be31a2ad4c69cfbd"
        malpedia_version = "20210616"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8dbc24b0000000 81f980000000 0f8676ffffff b880000000 29f0 89442420 0f8565050000 }
            // n = 7, score = 100
            //   8dbc24b0000000       | lea                 edi, dword ptr [esp + 0xb0]
            //   81f980000000         | cmp                 ecx, 0x80
            //   0f8676ffffff         | jbe                 0xffffff7c
            //   b880000000           | mov                 eax, 0x80
            //   29f0                 | sub                 eax, esi
            //   89442420             | mov                 dword ptr [esp + 0x20], eax
            //   0f8565050000         | jne                 0x56b

        $sequence_1 = { 8b84248c000000 23442410 898c2420010000 8b8c2488000000 234c240c 336c2404 338c2424010000 }
            // n = 7, score = 100
            //   8b84248c000000       | mov                 eax, dword ptr [esp + 0x8c]
            //   23442410             | and                 eax, dword ptr [esp + 0x10]
            //   898c2420010000       | mov                 dword ptr [esp + 0x120], ecx
            //   8b8c2488000000       | mov                 ecx, dword ptr [esp + 0x88]
            //   234c240c             | and                 ecx, dword ptr [esp + 0xc]
            //   336c2404             | xor                 ebp, dword ptr [esp + 4]
            //   338c2424010000       | xor                 ecx, dword ptr [esp + 0x124]

        $sequence_2 = { 8b9c2484000000 139c2494000000 8906 895604 660f6fe2 660f6fd8 894e08 }
            // n = 7, score = 100
            //   8b9c2484000000       | mov                 ebx, dword ptr [esp + 0x84]
            //   139c2494000000       | adc                 ebx, dword ptr [esp + 0x94]
            //   8906                 | mov                 dword ptr [esi], eax
            //   895604               | mov                 dword ptr [esi + 4], edx
            //   660f6fe2             | movdqa              xmm4, xmm2
            //   660f6fd8             | movdqa              xmm3, xmm0
            //   894e08               | mov                 dword ptr [esi + 8], ecx

        $sequence_3 = { 8b542478 1344240c 03542410 897c2460 89742464 8b7c247c 8bb424f8030000 }
            // n = 7, score = 100
            //   8b542478             | mov                 edx, dword ptr [esp + 0x78]
            //   1344240c             | adc                 eax, dword ptr [esp + 0xc]
            //   03542410             | add                 edx, dword ptr [esp + 0x10]
            //   897c2460             | mov                 dword ptr [esp + 0x60], edi
            //   89742464             | mov                 dword ptr [esp + 0x64], esi
            //   8b7c247c             | mov                 edi, dword ptr [esp + 0x7c]
            //   8bb424f8030000       | mov                 esi, dword ptr [esp + 0x3f8]

        $sequence_4 = { eb0f 83c501 0fb6842f840a4800 84c0 7449 895c2404 890424 }
            // n = 7, score = 100
            //   eb0f                 | jmp                 0x11
            //   83c501               | add                 ebp, 1
            //   0fb6842f840a4800     | movzx               eax, byte ptr [edi + ebp + 0x480a84]
            //   84c0                 | test                al, al
            //   7449                 | je                  0x4b
            //   895c2404             | mov                 dword ptr [esp + 4], ebx
            //   890424               | mov                 dword ptr [esp], eax

        $sequence_5 = { f7d0 21c8 334574 89bc24e0000000 897d68 899424e8000000 89742448 }
            // n = 7, score = 100
            //   f7d0                 | not                 eax
            //   21c8                 | and                 eax, ecx
            //   334574               | xor                 eax, dword ptr [ebp + 0x74]
            //   89bc24e0000000       | mov                 dword ptr [esp + 0xe0], edi
            //   897d68               | mov                 dword ptr [ebp + 0x68], edi
            //   899424e8000000       | mov                 dword ptr [esp + 0xe8], edx
            //   89742448             | mov                 dword ptr [esp + 0x48], esi

        $sequence_6 = { 8b8558470000 8b955c470000 89f9 884c246c 31f6 31ff 899c24b0000000 }
            // n = 7, score = 100
            //   8b8558470000         | mov                 eax, dword ptr [ebp + 0x4758]
            //   8b955c470000         | mov                 edx, dword ptr [ebp + 0x475c]
            //   89f9                 | mov                 ecx, edi
            //   884c246c             | mov                 byte ptr [esp + 0x6c], cl
            //   31f6                 | xor                 esi, esi
            //   31ff                 | xor                 edi, edi
            //   899c24b0000000       | mov                 dword ptr [esp + 0xb0], ebx

        $sequence_7 = { c744240cc8000000 894c2408 894c2418 e8???????? 8b97a0010000 89f8 8d9a00001000 }
            // n = 7, score = 100
            //   c744240cc8000000     | mov                 dword ptr [esp + 0xc], 0xc8
            //   894c2408             | mov                 dword ptr [esp + 8], ecx
            //   894c2418             | mov                 dword ptr [esp + 0x18], ecx
            //   e8????????           |                     
            //   8b97a0010000         | mov                 edx, dword ptr [edi + 0x1a0]
            //   89f8                 | mov                 eax, edi
            //   8d9a00001000         | lea                 ebx, dword ptr [edx + 0x100000]

        $sequence_8 = { 85d2 780d a1???????? 3b10 0f8c41010000 81fa46270000 0f8445050000 }
            // n = 7, score = 100
            //   85d2                 | test                edx, edx
            //   780d                 | js                  0xf
            //   a1????????           |                     
            //   3b10                 | cmp                 edx, dword ptr [eax]
            //   0f8c41010000         | jl                  0x147
            //   81fa46270000         | cmp                 edx, 0x2746
            //   0f8445050000         | je                  0x54b

        $sequence_9 = { 8b842450060000 89d3 89bc2428020000 31d5 8b7c2460 89ac242c020000 8b942454060000 }
            // n = 7, score = 100
            //   8b842450060000       | mov                 eax, dword ptr [esp + 0x650]
            //   89d3                 | mov                 ebx, edx
            //   89bc2428020000       | mov                 dword ptr [esp + 0x228], edi
            //   31d5                 | xor                 ebp, edx
            //   8b7c2460             | mov                 edi, dword ptr [esp + 0x60]
            //   89ac242c020000       | mov                 dword ptr [esp + 0x22c], ebp
            //   8b942454060000       | mov                 edx, dword ptr [esp + 0x654]

    condition:
        7 of them and filesize < 1425408
}